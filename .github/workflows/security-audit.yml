name: "Security Audit"

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  security-audit:
    name: Security & Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack and pin pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8.15.4 --activate
          npm config set registry https://registry.npmjs.org
          pnpm config set registry https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unified security audit (JSON)
        run: |
          node tools/security/quality-gate.js security-audit --format=json > security-report.json
        continue-on-error: false

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Prepare PR summary
        id: summary
        run: |
          if [ -f security-report.json ]; then
            STATUS=$(jq -r '.status // "unknown"' security-report.json)
            TOTAL=$(jq -r '.summary.totalIssues // 0' security-report.json)
            CRITICAL=$(jq -r '.summary.critical // 0' security-report.json)
            HIGH=$(jq -r '.summary.high // 0' security-report.json)
            MEDIUM=$(jq -r '.summary.medium // 0' security-report.json)
            LOW=$(jq -r '.summary.low // 0' security-report.json)
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = `## ðŸ”’ Security Audit Summary\n\n` +
              `**Status:** \`${{ steps.summary.outputs.status }}\`\n\n` +
              `| Severity | Count |\n|---|---|\n` +
              `| ðŸ”´ Critical | ${{ steps.summary.outputs.critical }} |\n` +
              `| ðŸŸ  High | ${{ steps.summary.outputs.high }} |\n` +
              `| ðŸŸ¡ Medium | ${{ steps.summary.outputs.medium }} |\n` +
              `| ðŸŸ¢ Low | ${{ steps.summary.outputs.low }} |\n`;
            if (fs.existsSync('security-report.json')) {
              body += `\n<details><summary>Raw JSON</summary>\n\n\`\n${fs.readFileSync('security-report.json','utf8')}\n\`\n\n</details>`;
            }
            const { context, github } = require('@actions/github');
            const issue_number = context.payload.pull_request.number;
            const comments = await github.rest.issues.listComments({ ...context.repo, issue_number });
            const existing = comments.data.find(c => c.user.type === 'Bot' && c.body.includes('Security Audit Summary'));
            if (existing) {
              await github.rest.issues.updateComment({ ...context.repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ ...context.repo, issue_number, body });
            }

      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: |
            security-report.json
          retention-days: 14